<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload to Google Drive with Auto Refresh Token</title>
    <link rel="stylesheet" href="styles.css"> <!-- Link to external CSS file -->
</head>
<body>

    <h2>Upload a File to Google Drive</h2>
    <div class="a">
        <input type="file" id="fileInput" />
        <button id="uploadButton">Upload File</button>
    </div>
    <p id="status"></p>

    <div id="progressContainer" style="display: none;">
        <div id="progressBar"></div>
    </div>

    <script>
        // Replace with your own credentials
        const CLIENT_ID = '462182650159-4l8cppkffpl4o6aet7vu2pvphjbipl79.apps.googleusercontent.com';
        const CLIENT_SECRET = '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';
        const REFRESH_TOKEN = '1//04lBH6A8GbG0iCgYIARAAGAQSNwF-L9IrJISIkkZC1h4bepgQcZECVoP3DqQrlfuRZLlsPRA7OW4aqT2ETTQSkFXQ_eS2m8D2Ikk';

        let accessToken = ''; // Initial access token
        let tokenExpirationTime = 0; // When the token will expire

        // Function to refresh the access token
        async function refreshAccessToken() {
            const params = new URLSearchParams();
            params.append('client_id', CLIENT_ID);
            params.append('client_secret', CLIENT_SECRET);
            params.append('refresh_token', REFRESH_TOKEN);
            params.append('grant_type', 'refresh_token');

            try {
                const response = await fetch('https://oauth2.googleapis.com/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params.toString(),
                });

                if (!response.ok) {
                    throw new Error('Failed to refresh access token');
                }

                const data = await response.json();
                accessToken = data.access_token; // Update access token
                const expiresIn = data.expires_in; // Typically 3600 seconds (1 hour)
                tokenExpirationTime = Date.now() + expiresIn * 1000; // Update expiration time
                console.log('New Access Token:', accessToken); // Log new token
            } catch (error) {
                console.error('Error refreshing access token:', error);
            }
        }

        // Function to upload a file to Google Drive
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a file to upload.');
                return;
            }

            // Check if access token is expired
            if (Date.now() >= tokenExpirationTime) {
                console.log('Access token expired, refreshing...');
                await refreshAccessToken();
                console.log('Access token refreshed, performing upload...');
            }

            performUpload(file);
        }

        // Function to perform the actual upload
        function performUpload(file) {
            console.log('Current Access Token before upload:', accessToken);

            const metadata = {
                'name': file.name,
                'mimeType': file.type,
                'parents': ['1CYYzPydSBcUaEZlZLGMn52II0C97RTJa'] // Replace with your folder ID
            };

            const formData = new FormData();
            formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            formData.append('file', file);

            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            progressContainer.style.display = 'block';

            fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({
                    'Authorization': 'Bearer ' + accessToken
                }),
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(`Error: ${response.status} ${text}`); });
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('status').textContent = 'File uploaded successfully!';
                console.log('File uploaded successfully:', data);
                progressBar.style.width = '100%';
            })
            .catch(error => {
                document.getElementById('status').textContent = 'File upload failed!';
                console.error('Error uploading file:', error);
            });
        }

        // Initial call to set the access token and expiration time
        function setInitialTokens(initialAccessToken, initialExpiresIn) {
            accessToken = initialAccessToken;
            tokenExpirationTime = Date.now() + initialExpiresIn * 1000;
        }

        // Event listener for the upload button
        document.getElementById('uploadButton').addEventListener('click', uploadFile);

        // Call setInitialTokens with your initial access token and its expiration time (in seconds)
        setInitialTokens('ya29.a0AcM612xMnTP1qvQ0NruHH08GCTP2JyNImkeMRudFLxSiMYJ07EyFFoMgfmh7fi2d7xs_nekLTRzuwY_027SX61tSlxdi0G9446q-joKPMmRF_2-PtsFdN_EUY1xnOZctjTbQNDm8SeBeve6kcBzRPiNxrziDyD6_PbLqY2wnaCgYKASgSARISFQHGX2Mi_ejvRBuffrbDCWDDEyHuRw0175', 3600); // Replace with your actual initial token
    </script>

</body>
</html>

